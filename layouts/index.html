{{ define "header" }}
<header class="header">
    <div class="header-container">
        <div class="logo">
            <a href="/" style="display: block; height: 100%; width: 100%;">
                <img src="/images/logo.png" alt="Modelyo Logo">
            </a>
        </div>
        {{/* <nav class="nav-menu">
            <a href="#product" class="nav-link">Product</a>
            <a href="#solutions" class="nav-link">Solutions</a>
            <a href="#resources" class="nav-link">Resources</a>
            <a href="#company" class="nav-link">Company</a>
            <a href="#demo" class="btn-demo">Start Demo</a>
        </nav> */}}
    </div>
</header>
{{ end }}

{{ define "main" }}
{{ with .Params }}
<!-- Hero Section -->
<section class="hero">
    <img src="{{ .hero.background_image }}" alt="Hero Background" class="hero-bg">
    <div class="hero-gradient"></div>
    <div class="hero-content">
        <h1 class="hero-title">
            {{ .hero.title }}<br>
            {{ .hero.subtitle }}
        </h1>
        <p class="hero-subtitle">
            {{ .hero.description }}
        </p>
        <a href="{{ .hero.cta_link }}" class="btn-gradient">{{ .hero.cta_text }}</a>
    </div>
</section>

<!-- Diagram Section -->
<section class="diagram-section">
    <video class="diagram-bg" autoplay loop muted playsinline>
        <source src="{{ .diagram.background_video }}" type="video/mp4">
    </video>
    <div class="diagram-content">
        <h2 class="diagram-title">{{ .diagram.title }}</h2>
        <div class="diagram-text">
            {{ .diagram.description | markdownify }}
        </div>
    </div>
</section>

<!-- Why Modelyo Section -->
<section class="why-section" id="why">
    <div class="why-bg">
        <img src="{{ .why_modelyo.background_image }}" alt="Why Background" style="width: 100%; height: 100%; object-fit: cover;">
    </div>
    <div class="why-overlay"></div>
    <div class="why-overlay-card">

    <div class="section">
        <div class="why-section-label">
            <span>{{ .why_modelyo.title }}</span>
        </div>
        <div class="why-content">
            {{ range .why_modelyo.cards }}
            <div class="why-card">
                <h3 class="why-card-title">{{ .title }}</h3>
                <p class="why-card-text">{{ .text }}</p>
            </div>
            {{ end }}
        </div>
        </div>
    </div>
</section>

<!-- Platform Layers Section -->
<section class="section platform-layers-section" style="background: var(--dark-blue-00); position: relative; min-height: 1080px; padding: 120px 200px; overflow: hidden;">
    <!-- 3D Canvas -->
    <canvas id="canvas3d" data-spline="{{ .platform_layers.spline_model }}"></canvas>
    <div style="position: relative; z-index: 10;">
        <h2 class="section-title">{{ .platform_layers.title }}</h2>
        <div class="platform-layers-grid">
            <div class="platform-layers-left">
                {{ range .platform_layers.layers.left }}
                <div class="platform-layer-item">
                    <p class="platform-layer-number">{{ .number }}</p>
                    <p class="platform-layer-title">{{ .title }}</p>
                </div>
                {{ end }}
            </div>
            <div class="platform-layers-right">
                {{ range .platform_layers.layers.right }}
                <div class="platform-layer-item platform-layer-item-right">
                    <p class="platform-layer-number">{{ .number }}</p>
                    <p class="platform-layer-title">{{ .title }}</p>
                </div>
                {{ end }}
            </div>
        </div>
    </div>
</section>

<!-- Opportunities Section -->
<section class="opportunities-section" id="opportunities">
    <!-- Hidden Data (Used by JS) -->
    <div class="opportunities-data" hidden>
        {{ range .opportunities.items }}
        <div class="opp-item"
             data-index="{{ .index }}"
             data-img="{{ .image }}"
             data-title="{{ .title }}"
             data-text="{{ .text }}"
             data-button="{{ .button_text }}">
        </div>
        {{ end }}
    </div>

    <!-- Visible Card -->
    <div class="opportunities-card">
        <!-- LEFT CONTENT -->
        <div class="opportunities-content">
            <!-- OPPORTUNITIES HEADER -->
            <div class="opportunities-header">
                <span class="opportunities-label">{{ .opportunities.label }}</span>
                <div class="opportunities-underline">
                    <span class="underline-accent"></span>
                </div>
            </div>

            <!-- DYNAMIC TITLE -->
            <h2 class="opportunities-title" id="opp-title">
                {{ (index .opportunities.items 0).title }}
            </h2>

            <!-- DYNAMIC TEXT -->
            <p class="opportunities-text" id="opp-text">
                {{ (index .opportunities.items 0).text }}
            </p>

            <a href="{{ .opportunities.cta_link }}" class="opp-btn" id="opp-btn">{{ .opportunities.cta_text }}</a>
        </div>

        <!-- RIGHT IMAGE -->
        <div class="opportunities-image">
            <img id="opp-image" src="{{ (index .opportunities.items 0).image }}" alt="Opportunity visual">
        </div>
    </div>

    <!-- BOTTOM TABS (OUTSIDE CARD) -->
    <div class="opportunities-bottom-tabs">
        {{ range .opportunities.items }}
        <button class="opp-tab {{ if eq .index 0 }}active{{ end }}" data-index="{{ .index }}">{{ .tab_label }}</button>
        {{ end }}
    </div>
</section>

<script src="/js/opportunities.js" defer></script>

<!-- Products Section -->
<section class="products-section" id="product">
    <div class="products-bg">
        <img src="{{ .products.background_image }}" alt="Products Background" style="width: 100%; height: 100%; object-fit: cover; object-position: center;">
    </div>
    <div style="position: relative; z-index: 10;">
        <div class="products-header">
            <span class="products-label">{{ .products.label }}</span>
            <div class="products-underline">
                <span class="underline-accent"></span>
            </div>
        </div>
        <h2 class="section-title">{{ .products.title }}</h2>
        <!-- Confidential Workspaces Card (Wide) -->
        <div class="product-card-wide">
            <div class="product-card-image-wide">
                <h3 class="product-card-title-wide">{{ .products.workspaces.title }}</h3>
                <img src="{{ .products.workspaces.image }}" alt="Confidential Workspaces">
            </div>
            <div class="product-card-content-wide">
                <p class="product-card-text-wide">{{ .products.workspaces.description }}</p>
            </div>
                <img src="/images/Arrow.svg" alt="Arrow" class="product-card-arrow-wide">
        </div>
        <div class="products-grid">
            {{ range .products.items }}
            <div class="product-card">
                <div class="product-card-image">
                    <h3 class="product-card-title">{{ .title | safeHTML }}</h3>
                    <img src="{{ .image }}" alt="{{ .title }}">
                </div>
                <div class="product-card-content">
                    <h4 class="product-card-subtitle">{{ .subtitle }}</h4>
                    <p class="product-card-text">{{ .description }}</p>
                </div>
                <img src="/images/Arrow.svg" alt="Arrow" class="product-card-arrow">
            </div>
            {{ end }}
        </div>
    </div>
</section>

<!-- Solutions Section -->
<section class="solutions-section" id="solutions">
    <div class="solutions-bg">
        <img src="/images/solution-bg.png" alt="Solutions Background" style="width: 100%; height: 100%; object-fit: cover; object-position: center;">
    </div>
    <div style="position: relative; z-index: 10;">
        <h2 class="section-title section-title-dark">{{ .solutions.title }}</h2>
        {{ range .solutions.items }}
    <div class="solution-card">
        <div class="solution-card-image">
            <img src="{{ .image }}" alt="{{ .title }}">
        </div>
        <div class="solution-card-content">
            <h3 class="solution-card-title">{{ .title }}</h3>
            <p class="solution-card-text">
                <strong>{{ .subtitle }}</strong><br><br>
                {{ .description | markdownify }}
            </p>
            <a href="{{ .link_url }}" class="solution-card-link">
                {{ .link_text }}
                <img src="/images/Arrow.svg" alt="Arrow" style="width: 20px; height: 20px;">
            </a>
        </div>
    </div>
    {{ end }}
    </div>
</section>

<!-- Partners Section -->
<section class="partners-section">
    <div class="partners-header">
        <span class="partners-label">{{ .partners.label }}</span>
    </div>
    <div class="partners-grid">
        {{ range .partners.logos }}
        <img src="{{ .image }}" alt="{{ .alt }}" class="partner-logo">
        {{ end }}
    </div>
</section>
{{ end }}
{{ end }}

{{ define "footer" }}
{{ with .Params.footer }}
<footer class="footer">
    <div class="footer-top-section">
        <div class="footer-logo-tagline">
            <img src="{{ .logo }}" alt="Modelyo Logo" class="footer-logo">
            {{ if .tagline }}
            <div class="footer-tagline-container">
                <p class="footer-tagline">{{ .tagline }}</p>
                <div class="footer-tagline-line"></div>
            </div>
            {{ end }}
        </div>
    </div>
    <div class="footer-content">
        <div>
            <div class="footer-description">
                {{ .description | markdownify }}
            </div>
        </div>
        <div>
            <h4 class="footer-column-title">Products</h4>
            {{ range .products }}
            <a href="#" class="footer-link">{{ . }}</a>
            {{ end }}
        </div>
        <div>
            <h4 class="footer-column-title">Solutions</h4>
            {{ range .solutions }}
            <a href="#" class="footer-link">{{ . }}</a>
            {{ end }}
        </div>
        <div>
            <h4 class="footer-column-title">Resources</h4>
            {{ range .resources }}
            <a href="#" class="footer-link">{{ . }}</a>
            {{ end }}
        </div>
        <div>
            <h4 class="footer-column-title">Company</h4>
            {{ range .company }}
            <a href="#" class="footer-link">{{ . }}</a>
            {{ end }}
        </div>
    </div>
    {{ if .tagline }}
    <div class="footer-bottom-tagline-section">
        <div class="footer-bottom-tagline-wrapper">
            <div class="footer-bottom-tagline-container">
                <div class="footer-bottom-tagline-line"></div>
            </div>
        </div>
        <div class="footer-newsletter">
            <p class="newsletter-title">{{ .newsletter.title }}</p>
            <form class="newsletter-form">
                <input type="email" placeholder="{{ .newsletter.placeholder }}" class="newsletter-input" required>
                <button type="submit" class="newsletter-submit">Submit</button>
            </form>
        </div>
    </div>
    {{ end }}
</footer>
{{ end }}
{{ end }}

{{ define "footer-bottom" }}
{{ with .Params.footer }}
<div class="footer-bottom">
    <div class="footer-bottom-content">
        <div class="footer-bottom-left">
            <div class="footer-legal">
                {{ range .legal }}
                <a href="#" class="footer-legal-link">{{ . }}</a>
                {{ end }}
            </div>
            <p class="footer-copyright">{{ .copyright }}</p>
        </div>
        <div class="footer-social">
            <a href="https://x.com/ModelyoTech" target="_blank" rel="noopener noreferrer" aria-label="Follow Modelyo on X (Twitter)">
                <img src="/images/social-x.svg" alt="X (Twitter)" class="social-icon social-icon-x">
            </a>
            <a href="https://il.linkedin.com/company/modelyo" target="_blank" rel="noopener noreferrer" aria-label="Follow Modelyo on LinkedIn">
                <img src="/images/social-linkedin.svg" alt="LinkedIn" class="social-icon social-icon-linkedin">
            </a>
            <a href="https://www.instagram.com/lifeatmodelyo/" target="_blank" rel="noopener noreferrer" aria-label="Follow Modelyo on Instagram">
                <img src="/images/social-instagram.svg" alt="Instagram" class="social-icon social-icon-instagram">
            </a>
        </div>
    </div>
</div>
{{ end }}
{{ end }}

{{ define "scripts" }}
<script type="importmap">
{
  "imports": {
    "@splinetool/runtime": "https://unpkg.com/@splinetool/runtime@1.12.22/build/runtime.js"
  }
}
</script>
<script type="module">
import { Application } from '@splinetool/runtime';

// Wait for DOM to be ready
function initSpline() {
  const canvas = document.getElementById('canvas3d');
  if (!canvas) {
    console.error('Canvas element not found');
    return;
  }
  
  const splineModelPath = canvas.getAttribute('data-spline');
  if (!splineModelPath) {
    console.error('Spline model path not found');
    return;
  }
  
  console.log('Initializing Spline with path:', splineModelPath);
  
  // Ensure canvas has proper dimensions
  const section = canvas.closest('.platform-layers-section');
  if (section) {
    const updateCanvasSize = () => {
      const rect = section.getBoundingClientRect();
      const dpr = window.devicePixelRatio || 1;
      canvas.width = rect.width * dpr;
      canvas.height = rect.height * dpr;
      canvas.style.width = rect.width + 'px';
      canvas.style.height = rect.height + 'px';
    };
    updateCanvasSize();
    window.addEventListener('resize', updateCanvasSize);
  }
  
  // Optimize canvas for smooth loading
  canvas.style.opacity = '0';
  canvas.style.transition = 'opacity 0.8s ease-in';
  
  try {
    const app = new Application(canvas);
    console.log('Spline Application created successfully');
    
    // Load scene asynchronously with smooth fade-in
    app.load(splineModelPath)
      .then(() => {
        console.log('Spline scene loaded successfully');
        // Fade in smoothly once loaded
        requestAnimationFrame(() => {
          canvas.style.opacity = '1';
        });
        
        // Optimize rendering after load completes
        setTimeout(() => {
          canvas.style.willChange = 'auto';
        }, 1000);
      })
      .catch((error) => {
        console.error('Error loading Spline scene:', error);
        console.error('Error details:', {
          message: error.message,
          stack: error.stack,
          path: splineModelPath
        });
        canvas.style.opacity = '0';
      });
    
    // Handle window resize for optimal performance (debounced)
    let resizeTimeout;
    const handleResize = () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => {
        const section = canvas.closest('.platform-layers-section');
        if (section) {
          const rect = section.getBoundingClientRect();
          const dpr = window.devicePixelRatio || 1;
          canvas.width = rect.width * dpr;
          canvas.height = rect.height * dpr;
          canvas.style.width = rect.width + 'px';
          canvas.style.height = rect.height + 'px';
        }
        // Application handles resize internally, but we ensure smooth updates
        if (app.setSize) {
          const section = canvas.closest('.platform-layers-section');
          if (section) {
            const rect = section.getBoundingClientRect();
            app.setSize(rect.width, rect.height);
          }
        }
      }, 150);
    };
    
    window.addEventListener('resize', handleResize, { passive: true });
    
    // Enable 3D model interaction while allowing page scrolling
    // Use a capture-phase listener to intercept wheel events before Spline handles them
    let isMousePressed = false;
    let lastInteractionTime = 0;
    
    // Track mouse state for interaction detection
    canvas.addEventListener('mousedown', () => {
      isMousePressed = true;
      lastInteractionTime = Date.now();
    }, { passive: true });
    
    canvas.addEventListener('mouseup', () => {
      isMousePressed = false;
    }, { passive: true });
    
    canvas.addEventListener('mouseleave', () => {
      isMousePressed = false;
    }, { passive: true });
    
    // Handle wheel events: allow page scrolling when not actively interacting
    // When mouse is pressed, allow Spline to handle zoom/rotation
    canvas.addEventListener('wheel', (e) => {
      const timeSinceInteraction = Date.now() - lastInteractionTime;
      
      // If mouse is not pressed and it's been a moment since last interaction,
      // manually scroll the page to bypass Spline's wheel handling
      if (!isMousePressed && timeSinceInteraction > 150) {
        // Manually scroll the window
        window.scrollBy({
          top: e.deltaY,
          left: e.deltaX,
          behavior: 'auto'
        });
        // Prevent the event from reaching Spline
        e.preventDefault();
        e.stopPropagation();
        return false;
      }
      // If actively interacting, let Spline handle zoom/rotation
      // Don't prevent - let Spline's handlers process it
    }, { passive: false, capture: true });
    
  } catch (error) {
    console.error('Error initializing Spline:', error);
    console.error('Error details:', {
      message: error.message,
      stack: error.stack,
      name: error.name
    });
    canvas.style.opacity = '0';
  }
}

// Also handle import errors
window.addEventListener('error', (event) => {
  if (event.message && event.message.includes('splinetool')) {
    console.error('Spline runtime import error:', event);
  }
}, true);

// Initialize when DOM is ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initSpline);
} else {
  // DOM already loaded, initialize immediately
  initSpline();
}
</script>
{{ end }}
